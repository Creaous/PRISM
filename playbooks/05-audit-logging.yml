---
- name: Configure auditing and logging for Wazuh integration
  hosts: all
  become: true
  handlers:
    - name: Import shared handlers
      ansible.builtin.import_tasks: handlers/main.yml

  tasks:
    - name: Install audit and monitoring packages
      ansible.builtin.include_tasks: tasks/install_packages.yml
      vars:
        package_list:
          - auditd
          - audispd-plugins
          - sysstat
          - acct

    - name: Enable system monitoring services
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: true
        state: started
        masked: false
      loop:
        - auditd
        - sysstat
        - acct

    - name: Enable sysstat data collection
      ansible.builtin.lineinfile:
        path: /etc/default/sysstat
        regexp: '^ENABLED='
        line: 'ENABLED="true"'
        state: present
      when: ansible_facts['os_family'] == "Debian"

    - name: Configure audit rules for Wazuh integration
      ansible.builtin.copy:
        dest: /etc/audit/rules.d/hardening.rules
        mode: "{{ default_secure_mode }}"
        owner: "{{ default_root_owner }}"
        group: "{{ default_root_group }}"
        content: |
          # Delete all existing rules
          -D

          # Buffer size
          -b 8192

          # Failure mode (0=silent 1=printk 2=panic)
          -f 1

          # Monitor unauthorized access attempts
          -a always,exit -F arch=b64 -S open,openat,openat2 -F exit=-EACCES -k access
          -a always,exit -F arch=b64 -S open,openat,openat2 -F exit=-EPERM -k access

          # Monitor modifications to critical files
          -w /etc/passwd -p wa -k identity
          -w /etc/group -p wa -k identity
          -w /etc/shadow -p wa -k identity
          -w /etc/gshadow -p wa -k identity
          -w /etc/sudoers -p wa -k sudoers
          -w /etc/sudoers.d/ -p wa -k sudoers

          # Monitor system calls
          -a always,exit -F arch=b64 -S adjtimex,settimeofday -k time_change
          -a always,exit -F arch=b64 -S sethostname,setdomainname -k system_locale
          -a always,exit -F arch=b64 -S mount,umount2 -k mounts

          # Monitor SSH configuration
          -w /etc/ssh/sshd_config -p wa -k sshd_config

          # Make configuration immutable
          -e 2
      notify: Restart auditd
